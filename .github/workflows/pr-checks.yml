name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Verificar t√≠tulo del PR
  pr-title-check:
    name: Verificar T√≠tulo del PR
    runs-on: ubuntu-latest

    steps:
      - name: Validar t√≠tulo
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

  # An√°lisis de cambios
  changes-analysis:
    name: An√°lisis de Cambios
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar archivos modificados
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            database:
              - 'backend/prisma/**'
            workflows:
              - '.github/workflows/**'

      - name: Resumen de cambios
        run: |
          echo "### üìä Resumen de Cambios" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend modificado: ${{ steps.changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend modificado: ${{ steps.changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Base de datos modificada: ${{ steps.changes.outputs.database }}" >> $GITHUB_STEP_SUMMARY
          echo "- Workflows modificados: ${{ steps.changes.outputs.workflows }}" >> $GITHUB_STEP_SUMMARY

  # Verificar tama√±o del PR
  pr-size-check:
    name: Verificar Tama√±o del PR
    runs-on: ubuntu-latest

    steps:
      - name: Verificar tama√±o
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let label = 'size/XS';
            let message = '‚úÖ PR de tama√±o peque√±o';

            if (total > 1000) {
              label = 'size/XL';
              message = '‚ö†Ô∏è PR muy grande. Considera dividirlo en PRs m√°s peque√±os.';
            } else if (total > 500) {
              label = 'size/L';
              message = '‚ö†Ô∏è PR grande. Considera dividirlo si es posible.';
            } else if (total > 200) {
              label = 'size/M';
              message = '‚ÑπÔ∏è PR de tama√±o mediano';
            } else if (total > 50) {
              label = 'size/S';
              message = '‚úÖ PR de tama√±o peque√±o';
            }

            console.log(`${message} (${total} l√≠neas cambiadas)`);

            // Agregar comentario si es muy grande
            if (total > 1000) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `### ‚ö†Ô∏è Pull Request muy grande\n\n` +
                      `Este PR modifica **${total}** l√≠neas de c√≥digo (${additions} adiciones, ${deletions} eliminaciones).\n\n` +
                      `Considera dividirlo en PRs m√°s peque√±os para facilitar la revisi√≥n.`
              });
            }

  # Comentario autom√°tico de bienvenida
  welcome-comment:
    name: Comentario de Bienvenida
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Agregar comentario
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `### üëã ¬°Gracias por tu contribuci√≥n!\n\n` +
                    `Tu Pull Request ser√° revisado pronto.\n\n` +
                    `**Checklist de revisi√≥n:**\n` +
                    `- [ ] Los tests pasan correctamente\n` +
                    `- [ ] El c√≥digo sigue los est√°ndares del proyecto\n` +
                    `- [ ] La documentaci√≥n est√° actualizada\n` +
                    `- [ ] No hay conflictos de merge\n\n` +
                    `*Este es un comentario autom√°tico generado por GitHub Actions*`
            });
