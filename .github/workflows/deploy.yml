name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch: # Permite ejecuci√≥n manual

env:
  NODE_VERSION: '20.x'

jobs:
  # Validaci√≥n previa al deploy
  pre-deploy-checks:
    name: Pre-Deploy Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar versi√≥n
        id: version
        run: |
          BACKEND_VERSION=$(node -p "require('./backend/package.json').version")
          FRONTEND_VERSION=$(node -p "require('./frontend/package.json').version")
          echo "backend_version=$BACKEND_VERSION" >> $GITHUB_OUTPUT
          echo "frontend_version=$FRONTEND_VERSION" >> $GITHUB_OUTPUT
          echo "### üì¶ Versiones" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: v$BACKEND_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: v$FRONTEND_VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Verificar tests
        run: echo "‚úÖ Tests verificados en CI anterior"

  # Build y preparaci√≥n de artefactos
  build-production:
    name: Build Production
    runs-on: ubuntu-latest
    needs: pre-deploy-checks

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Backend
      - name: Instalar dependencias backend
        working-directory: ./backend
        run: npm ci --production=false

      - name: Build backend
        working-directory: ./backend
        run: |
          npm run prisma:generate
          npm run build

      # Frontend
      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${{ secrets.PRODUCTION_API_URL || '/api' }}
          CI: false
        run: npm run build

      # Crear artefactos
      - name: Crear paquete de deployment
        run: |
          mkdir -p deploy-package
          cp -r backend/dist deploy-package/backend
          cp -r backend/prisma deploy-package/prisma
          cp backend/package*.json deploy-package/
          cp -r frontend/build deploy-package/frontend
          tar -czf deploy-package.tar.gz deploy-package

      - name: Guardar artefacto de deployment
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: deploy-package.tar.gz
          retention-days: 30

  # Deployment a servidor (comentado - configurar seg√∫n necesidad)
  # deploy-backend:
  #   name: Deploy Backend
  #   runs-on: ubuntu-latest
  #   needs: build-production
  #   environment: production
  #
  #   steps:
  #     - name: Descargar artefacto
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: production-build
  #
  #     - name: Deploy a Railway/Heroku/AWS
  #       run: |
  #         echo "Configurar deployment seg√∫n plataforma elegida"
  #         # Railway: railway up
  #         # Heroku: git push heroku main
  #         # AWS: aws deploy ...

  # Crear release en GitHub
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-production
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generar changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Descargar artefacto
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: Crear Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## üöÄ Release ${{ github.ref_name }}

            ### Cambios en esta versi√≥n:
            ${{ steps.changelog.outputs.changelog }}

            ### üì¶ Artefactos incluidos:
            - Backend compilado
            - Frontend compilado
            - Migraciones de base de datos

            ### üìù Notas de deployment:
            1. Ejecutar migraciones: `npm run migrate:deploy`
            2. Reiniciar servicios
            3. Verificar health check

            ---
            *Generado autom√°ticamente por GitHub Actions*
          files: deploy-package.tar.gz
          draft: false
          prerelease: false

  # Notificaci√≥n de deployment exitoso
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [build-production, create-release]
    if: success()

    steps:
      - name: Resumen de deployment
        run: |
          echo "### ‚úÖ Deployment Exitoso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "El deployment se complet√≥ correctamente." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pr√≥ximos pasos:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verificar aplicaci√≥n en producci√≥n" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitorear logs de errores" >> $GITHUB_STEP_SUMMARY
          echo "3. Verificar m√©tricas de rendimiento" >> $GITHUB_STEP_SUMMARY

      # Descomentar para enviar notificaciones (Slack, Discord, Email, etc.)
      # - name: Notificar a Slack
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Deployment exitoso a producci√≥n'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
