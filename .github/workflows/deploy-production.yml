name: Deploy to Production (Vercel + Railway)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecución manual

env:
  NODE_VERSION: '20.x'

jobs:
  # Pre-Deploy Validation
  pre-deploy:
    name: Pre-Deploy Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Validar archivos necesarios
        run: |
          echo "✅ Validación pre-deploy completada"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

  # Deployment automático a Vercel (Frontend)
  deploy-vercel:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: pre-deploy
    # Solo ejecutar si existen los secrets necesarios
    if: ${{ secrets.VERCEL_TOKEN != '' }}
    environment:
      name: production-frontend
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy a Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod'
        continue-on-error: true

      - name: Comentar URL de deployment
        if: steps.deploy.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.url }}';
            console.log(`✅ Frontend desplegado en: ${deploymentUrl}`);

  # Railway se despliega automáticamente via webhook desde GitHub
  # Este job solo valida que el backend esté funcionando después del deploy
  verify-backend:
    name: Verify Backend Deployment
    runs-on: ubuntu-latest
    needs: deploy-vercel
    if: ${{ success() && secrets.BACKEND_URL != '' }}

    steps:
      - name: Esperar a que Railway termine el deploy
        run: sleep 60

      - name: Health Check del Backend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "✅ Backend está funcionando correctamente"
          else
            echo "⚠️ Backend health check falló (HTTP $response)"
            echo "Esto puede ser normal si Railway aún está deployando"
          fi
        continue-on-error: true

      - name: Verificar conectividad Frontend → Backend
        run: |
          echo "Frontend URL: ${{ secrets.FRONTEND_URL }}"
          echo "Backend URL: ${{ secrets.BACKEND_URL }}"
          echo "✅ Deployment completado"

  # Notificación de deployment exitoso
  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-vercel, verify-backend]
    if: success()

    steps:
      - name: Generar resumen
        run: |
          echo "### ✅ Deployment a Producción Exitoso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend (Vercel):** Desplegado ✅" >> $GITHUB_STEP_SUMMARY
          echo "**Backend (Railway):** Verificado ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Próximos pasos:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verificar aplicación en producción" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitorear logs de Railway" >> $GITHUB_STEP_SUMMARY
          echo "3. Verificar métricas en Vercel Analytics" >> $GITHUB_STEP_SUMMARY

  # Manejo de fallos
  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-vercel, verify-backend]
    if: failure()

    steps:
      - name: Generar reporte de error
        run: |
          echo "### ❌ Deployment a Producción Falló" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Revisar:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Logs de Vercel" >> $GITHUB_STEP_SUMMARY
          echo "2. Logs de Railway" >> $GITHUB_STEP_SUMMARY
          echo "3. Variables de entorno" >> $GITHUB_STEP_SUMMARY
          echo "4. Health checks" >> $GITHUB_STEP_SUMMARY
