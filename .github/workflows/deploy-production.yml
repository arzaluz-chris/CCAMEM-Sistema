name: Deploy to Production (Vercel + Railway)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecuciÃ³n manual

env:
  NODE_VERSION: '20.x'

jobs:
  # Deployment automÃ¡tico a Vercel (Frontend)
  deploy-vercel:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    environment:
      name: production-frontend
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy a Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod'

      - name: Comentar URL de deployment
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.url }}';
            console.log(`âœ… Frontend desplegado en: ${deploymentUrl}`);

  # Railway se despliega automÃ¡ticamente via webhook desde GitHub
  # Este job solo valida que el backend estÃ© funcionando despuÃ©s del deploy
  verify-backend:
    name: Verify Backend Deployment
    runs-on: ubuntu-latest
    needs: deploy-vercel
    if: success()

    steps:
      - name: Esperar a que Railway termine el deploy
        run: sleep 60

      - name: Health Check del Backend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Backend estÃ¡ funcionando correctamente"
          else
            echo "âŒ Backend health check fallÃ³ (HTTP $response)"
            exit 1
          fi

      - name: Verificar conectividad Frontend â†’ Backend
        run: |
          echo "Frontend URL: ${{ secrets.FRONTEND_URL }}"
          echo "Backend URL: ${{ secrets.BACKEND_URL }}"
          echo "âœ… Deployment completado exitosamente"

  # NotificaciÃ³n de deployment exitoso
  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-vercel, verify-backend]
    if: success()

    steps:
      - name: Generar resumen
        run: |
          echo "### âœ… Deployment a ProducciÃ³n Exitoso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend (Vercel):** Desplegado âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**Backend (Railway):** Verificado âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ secrets.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API: ${{ secrets.BACKEND_URL }}/api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrÃ³ximos pasos:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verificar aplicaciÃ³n en producciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "2. Monitorear logs de Railway" >> $GITHUB_STEP_SUMMARY
          echo "3. Verificar mÃ©tricas en Vercel Analytics" >> $GITHUB_STEP_SUMMARY

      # Descomentar para notificaciones
      # - name: Enviar notificaciÃ³n a Slack
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: success
      #     text: 'ðŸš€ Deployment a producciÃ³n exitoso'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Manejo de fallos
  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-vercel, verify-backend]
    if: failure()

    steps:
      - name: Generar reporte de error
        run: |
          echo "### âŒ Deployment a ProducciÃ³n FallÃ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Revisar:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Logs de Vercel" >> $GITHUB_STEP_SUMMARY
          echo "2. Logs de Railway" >> $GITHUB_STEP_SUMMARY
          echo "3. Variables de entorno" >> $GITHUB_STEP_SUMMARY
          echo "4. Health checks" >> $GITHUB_STEP_SUMMARY
